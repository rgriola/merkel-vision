generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      Int                      @id @default(autoincrement())
  email                   String                   @unique
  username                String                   @unique
  passwordHash            String
  firstName               String?
  lastName                String?
  dateOfBirth             DateTime?
  emailVerified           Boolean                  @default(false)
  verificationToken       String?
  resetToken              String?
  resetTokenExpiry        DateTime?
  isActive                Boolean                  @default(true)
  isAdmin                 Boolean                  @default(false)
  role                    String                   @default("user") // user, staffer, super_admin
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  appleId                 String?                  @unique
  avatar                  String?
  avatarFileId            String?
  bannerImage             String?
  bannerFileId            String?
  city                    String?
  country                 String?
  googleId                String?                  @unique
  language                String?                  @default("en")
  lastLoginAt             DateTime?
  phoneNumber             String?
  timezone                String?
  gpsPermission           String?                  @default("not_asked")
  gpsPermissionUpdated    DateTime?
  homeLocationName        String?
  homeLocationLat         Float?
  homeLocationLng         Float?
  homeLocationUpdated     DateTime?
  verificationTokenExpiry DateTime?
  lastVerificationEmailSent DateTime?
  bio                     String?
  deletedAt               DateTime?
  emailNotifications      Boolean                  @default(true)
  twoFactorEnabled        Boolean                  @default(false)
  twoFactorSecret         String?
  failedLoginAttempts     Int                      @default(0)
  lockedUntil             DateTime?
  // Privacy Settings
  profileVisibility       String                   @default("public") // public, followers, private
  showInSearch            Boolean                  @default(true)
  showLocation            Boolean                  @default(true)
  showSavedLocations      String                   @default("public") // public, followers, private
  allowFollowRequests     Boolean                  @default(true)
  phoneVerification       PhoneVerification[]
  createdLocations        Location[]               @relation("LocationCreator")
  modifiedLocations       Location[]               @relation("LocationModifier")
  uploadedPhotos          Photo[]                  @relation("PhotoUploader")
  projects                Project[]
  projectMemberships      ProjectMember[]
  securityLogs            SecurityLog[]
  sessions                Session[]
  invitedTeamMembers      TeamMember[]             @relation("TeamInviter")
  teamMemberships         TeamMember[]             @relation("TeamMember")
  savedLocations          UserSave[]
  emailChangeRequests     EmailChangeRequest[]
  usernameChangeRequests  UsernameChangeRequest[]
  following               UserFollow[]             @relation("Following")
  followers               UserFollow[]             @relation("Followers")
  oauthAuthorizationCodes OAuthAuthorizationCode[]
  oauthRefreshTokens      OAuthRefreshToken[]
  createdTemplates        EmailTemplate[]          @relation("TemplateCreator")
  updatedTemplates        EmailTemplate[]          @relation("TemplateUpdater")
  createdTemplateVersions EmailTemplateVersion[]   @relation("VersionCreator")

  @@index([city])
  @@index([country])
  @@map("users")
}

model PhoneVerification {
  id          Int      @id @default(autoincrement())
  userId      Int
  phoneNumber String
  code        String
  expiresAt   DateTime
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([phoneNumber])
  @@index([code])
}

model Location {
  id               Int               @id @default(autoincrement())
  placeId          String
  name             String
  address          String?
  lat              Float
  lng              Float
  type             String?
  rating           Float?
  createdBy        Int
  lastModifiedBy   Int?
  lastModifiedAt   DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  access           String?
  city             String?
  entryPoint       String?
  isPermanent      Boolean           @default(false)
  number           String?
  parking          String?
  productionNotes  String?
  state            String?
  street           String?
  zipcode          String?
  bestTimeOfDay    String?
  contactPerson    String?
  contactPhone     String?
  indoorOutdoor    String?
  operatingHours   String?
  permitCost       Float?
  permitRequired   Boolean           @default(false)
  restrictions     String?
  contacts         LocationContact[]
  creator          User              @relation("LocationCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  lastModifier     User?             @relation("LocationModifier", fields: [lastModifiedBy], references: [id])
  photos           Photo[]
  projectLocations ProjectLocation[]
  savedBy          UserSave[]

  @@index([createdBy])
  @@index([lastModifiedBy])
  @@index([placeId])
  @@map("locations")
}

model UserSave {
  id             Int       @id @default(autoincrement())
  userId         Int
  locationId     Int
  savedAt        DateTime  @default(now())
  color          String?
  isFavorite     Boolean   @default(false)
  personalRating Float?
  caption        String?   // User's personal caption/note for this location
  tags           Json?
  visitedAt      DateTime?
  visibility     String    @default("private") // 'public', 'unlisted', 'private'
  location       Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([locationId])
  @@index([visibility]) // For filtering public/unlisted locations
  @@map("user_saves")
}

model Session {
  id           String   @id @default(cuid())
  userId       Int
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  ipAddress    String?
  isActive     Boolean  @default(true)
  lastAccessed DateTime @default(now())
  userAgent    String?
  country      String?
  deviceName   String?
  deviceType   String?
  loginMethod  String?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model Photo {
  id               Int       @id @default(autoincrement())
  locationId       Int
  placeId          String
  userId           Int?
  imagekitFileId   String
  imagekitFilePath String
  originalFilename String?
  fileSize         Int?
  mimeType         String?
  width            Int?
  height           Int?
  isPrimary        Boolean   @default(false)
  caption          String?
  uploadedAt       DateTime  @default(now())
  gpsLatitude      Float?
  gpsLongitude     Float?
  gpsAltitude      Float?
  gpsAccuracy      Float?
  cameraMake       String?
  cameraModel      String?
  lensMake         String?
  lensModel        String?
  dateTaken        DateTime?
  iso              Int?
  focalLength      String?
  aperture         String?
  shutterSpeed     String?
  exposureMode     String?
  whiteBalance     String?
  flash            String?
  orientation      Int?
  colorSpace       String?
  tags             String?
  uploadSource     String?   @default("manual")
  hasGpsData       Boolean   @default(false)
  location         Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  uploader         User?     @relation("PhotoUploader", fields: [userId], references: [id], onDelete: Cascade)

  @@index([locationId])
  @@index([placeId])
  @@index([userId])
  @@index([dateTaken], map: "idx_photos_dateTaken")
  @@index([hasGpsData], map: "idx_photos_hasGpsData")
  @@index([uploadSource], map: "idx_photos_uploadSource")
  @@map("photos")
}

model Project {
  id          Int               @id @default(autoincrement())
  userId      Int
  name        String
  description String?
  startDate   DateTime?
  endDate     DateTime?
  budget      Float?
  status      String            @default("planning")
  color       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  locations   ProjectLocation[]
  members     ProjectMember[]
  owner       User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("projects")
}

model ProjectLocation {
  id         Int       @id @default(autoincrement())
  projectId  Int
  locationId Int
  shootDate  DateTime?
  notes      String?
  addedAt    DateTime  @default(now())
  location   Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, locationId])
  @@index([locationId])
  @@map("project_locations")
}

model ProjectMember {
  id        Int      @id @default(autoincrement())
  projectId Int
  userId    Int
  role      String   @default("viewer") // viewer, editor, admin, owner
  addedAt   DateTime @default(now())
  addedBy   Int?
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId])
  @@map("project_members")
}

model LocationContact {
  id         Int      @id @default(autoincrement())
  locationId Int
  name       String
  role       String?
  email      String?
  phone      String?
  notes      String?
  createdAt  DateTime @default(now())
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([locationId])
  @@map("location_contacts")
}

model TeamMember {
  id        Int      @id @default(autoincrement())
  userId    Int
  invitedBy Int
  role      String   @default("viewer")
  joinedAt  DateTime @default(now())
  inviter   User     @relation("TeamInviter", fields: [invitedBy], references: [id], onDelete: Cascade)
  user      User     @relation("TeamMember", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, invitedBy])
  @@index([invitedBy])
  @@map("team_members")
}

model SecurityLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  eventType String
  ipAddress String?
  userAgent String?
  location  String?
  success   Boolean  @default(true)
  metadata  Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@map("security_logs")
}

model EmailChangeRequest {
  id           Int       @id @default(autoincrement())
  userId       Int
  oldEmail     String
  newEmail     String
  token        String    @unique
  expiresAt    DateTime
  cancelToken  String    @unique
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime  @default(now())
  completedAt  DateTime?
  cancelledAt  DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([cancelToken])
  @@index([createdAt])
  @@map("email_change_requests")
}

model UsernameChangeRequest {
  id            Int       @id @default(autoincrement())
  userId        Int
  oldUsername   String
  newUsername   String
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())
  completedAt   DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("username_change_requests")
}

model ReservedUsername {
  username  String   @id
  reason    String
  createdAt DateTime @default(now())

  @@map("reserved_usernames")
}

model UserFollow {
  id          Int      @id @default(autoincrement())
  followerId  Int      // User who is following
  followingId Int      // User being followed
  createdAt   DateTime @default(now())
  
  follower    User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_follows")
}

model OAuthClient {
  id                     String                   @id @default(cuid())
  clientId               String                   @unique
  clientSecret           String?                  // Null for public clients (mobile apps)
  name                   String
  redirectUris           String[]                 // Array of allowed redirect URIs
  scopes                 String[]                 // Array of allowed scopes
  grantTypes             String[]                 // ['authorization_code', 'refresh_token']
  isPublic               Boolean                  @default(true) // Public clients don't have secrets
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  
  authorizationCodes     OAuthAuthorizationCode[]
  refreshTokens          OAuthRefreshToken[]
  
  @@map("oauth_clients")
}

model OAuthAuthorizationCode {
  id                    String      @id @default(cuid())
  code                  String      @unique
  clientId              String
  userId                Int
  redirectUri           String
  codeChallenge         String      // PKCE code challenge
  codeChallengeMethod   String      // 'S256' or 'plain'
  scopes                String[]
  expiresAt             DateTime    // Short-lived: 10 minutes
  used                  Boolean     @default(false)
  usedAt                DateTime?
  createdAt             DateTime    @default(now())
  
  client                OAuthClient @relation(fields: [clientId], references: [clientId], onDelete: Cascade)
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([code])
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  @@map("oauth_authorization_codes")
}

model OAuthRefreshToken {
  id           String      @id @default(cuid())
  token        String      @unique
  clientId     String
  userId       Int
  scopes       String[]
  expiresAt    DateTime    // Long-lived: 30 days
  revoked      Boolean     @default(false)
  revokedAt    DateTime?
  createdAt    DateTime    @default(now())
  lastUsedAt   DateTime    @default(now())
  
  // Device tracking for security
  deviceName   String?
  deviceType   String?     // 'ios', 'android', 'web'
  userAgent    String?
  ipAddress    String?
  
  client       OAuthClient @relation(fields: [clientId], references: [clientId], onDelete: Cascade)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
  @@index([clientId])
  @@index([expiresAt])
  @@map("oauth_refresh_tokens")
}

// ============================================================================
// EMAIL TEMPLATES SYSTEM
// ============================================================================

model EmailTemplate {
  id                  Int                    @id @default(autoincrement())
  
  // Template Identity
  key                 String                 @unique // e.g., 'verification', 'password_reset', 'welcome'
  name                String                 // Display name: "Email Verification Template"
  description         String?                // Purpose of this template
  category            String                 @default("system") // 'system', 'notification', 'campaign'
  
  // Email Content
  subject             String                 // Email subject line
  htmlBody            String                 @db.Text // Full HTML template
  textBody            String?                @db.Text // Plain text fallback
  previewText         String?                // Email preview text (first line in inbox)
  
  // Customization
  brandColor          String                 @default("#4285f4")
  headerGradientStart String                 @default("#4285f4")
  headerGradientEnd   String                 @default("#5a67d8")
  buttonColor         String                 @default("#4285f4")
  
  // Template Variables (JSON array of required variables)
  requiredVariables   Json                   @default("[]")
  
  // Status & Versioning
  isActive            Boolean                @default(true)
  version             Int                    @default(1)
  isDefault           Boolean                @default(false) // System default templates
  deletedAt           DateTime?              // Soft delete timestamp
  
  // Metadata
  createdBy           Int?
  updatedBy           Int?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  
  // Relations
  creator             User?                  @relation("TemplateCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  updater             User?                  @relation("TemplateUpdater", fields: [updatedBy], references: [id], onDelete: SetNull)
  versions            EmailTemplateVersion[]
  usageLogs           EmailLog[]
  
  @@index([key])
  @@index([category])
  @@index([isActive])
  @@index([deletedAt])
  @@map("email_templates")
}

model EmailTemplateVersion {
  id            Int           @id @default(autoincrement())
  templateId    Int
  
  // Version Info
  version       Int
  changeNote    String?       // What changed in this version
  
  // Snapshot of Content
  subject       String
  htmlBody      String        @db.Text
  textBody      String?       @db.Text
  customization Json          // Store all color/style settings
  
  // Metadata
  createdBy     Int?
  createdAt     DateTime      @default(now())
  
  // Relations
  template      EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  creator       User?         @relation("VersionCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  
  @@index([templateId])
  @@index([version])
  @@map("email_template_versions")
}

model EmailLog {
  id            Int            @id @default(autoincrement())
  
  // Email Details
  templateId    Int?
  to            String
  subject       String
  status        String         // 'sent', 'failed', 'queued'
  
  // Metadata
  sentAt        DateTime       @default(now())
  errorMessage  String?        @db.Text
  
  // Relations
  template      EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  @@index([templateId])
  @@index([to])
  @@index([sentAt])
  @@index([status])
  @@map("email_logs")
}
