generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                      Int           @id @default(autoincrement())
  email                   String        @unique
  username                String        @unique
  passwordHash            String
  firstName               String?
  lastName                String?
  emailVerified           Boolean       @default(false)
  verificationToken       String?
  resetToken              String?
  resetTokenExpiry        DateTime?
  isActive                Boolean       @default(true)
  isAdmin                 Boolean       @default(false)
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  appleId                 String?       @unique
  avatar                  String?       @db.Text
  city                    String?
  country                 String?
  googleId                String?       @unique
  language                String?       @default("en")
  lastLoginAt             DateTime?
  phoneNumber             String?
  timezone                String?
  gpsPermission           String?       @default("not_asked")
  gpsPermissionUpdated    DateTime?
  verificationTokenExpiry DateTime?
  bio                     String?       @db.Text
  deletedAt               DateTime?
  emailNotifications      Boolean       @default(true)
  twoFactorEnabled        Boolean       @default(false)
  twoFactorSecret         String?
  failedLoginAttempts     Int           @default(0)
  lockedUntil             DateTime?
  createdLocations        Location[]    @relation("LocationCreator")
  modifiedLocations       Location[]    @relation("LocationModifier")
  uploadedPhotos          Photo[]       @relation("PhotoUploader")
  projects                Project[]
  securityLogs            SecurityLog[]
  sessions                Session[]
  invitedTeamMembers      TeamMember[]  @relation("TeamInviter")
  teamMemberships         TeamMember[]  @relation("TeamMember")
  savedLocations          UserSave[]

  @@map("users")
}

model Location {
  id               Int               @id @default(autoincrement())
  placeId          String            @unique
  name             String
  address          String?           @db.Text
  lat              Float
  lng              Float
  type             String?
  rating           Float?
  createdBy        Int
  lastModifiedBy   Int?
  lastModifiedAt   DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  access           String?           @db.Text
  city             String?
  entryPoint       String?           @db.Text
  isPermanent      Boolean           @default(false)
  number           String?
  parking          String?           @db.Text
  productionNotes  String?           @db.Text
  state            String?
  street           String?
  zipcode          String?
  bestTimeOfDay    String?
  contactPerson    String?
  contactPhone     String?
  indoorOutdoor    String?
  operatingHours   String?
  permitCost       Float?
  permitRequired   Boolean           @default(false)
  restrictions     String?           @db.Text
  contacts         LocationContact[]
  creator          User              @relation("LocationCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  lastModifier     User?             @relation("LocationModifier", fields: [lastModifiedBy], references: [id])
  projectLocations ProjectLocation[]
  savedBy          UserSave[]

  @@index([createdBy], map: "locations_createdBy_fkey")
  @@index([lastModifiedBy], map: "locations_lastModifiedBy_fkey")
  @@map("locations")
}

model UserSave {
  id             Int       @id @default(autoincrement())
  userId         Int
  locationId     Int
  savedAt        DateTime  @default(now())
  caption        String?   @db.Text
  color          String?
  isFavorite     Boolean   @default(false)
  personalRating Float?
  tags           Json?
  visitedAt      DateTime?
  location       Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([locationId], map: "user_saves_locationId_fkey")
  @@map("user_saves")
}

model Session {
  id           String   @id @default(cuid())
  userId       Int
  token        String   @unique @db.VarChar(500)
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  ipAddress    String?
  isActive     Boolean  @default(true)
  lastAccessed DateTime @default(now())
  userAgent    String?  @db.Text
  country      String?
  deviceName   String?
  deviceType   String?
  loginMethod  String?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "sessions_userId_fkey")
  @@map("sessions")
}

model Photo {
  id               Int       @id @default(autoincrement())
  placeId          String
  userId           Int?
  imagekitFileId   String
  imagekitFilePath String
  originalFilename String?
  fileSize         Int?
  mimeType         String?
  width            Int?
  height           Int?
  isPrimary        Boolean   @default(false)
  caption          String?   @db.Text
  uploadedAt       DateTime  @default(now())
  gpsLatitude      Float?
  gpsLongitude     Float?
  gpsAltitude      Float?
  gpsAccuracy      Float?
  cameraMake       String?   @db.VarChar(100)
  cameraModel      String?   @db.VarChar(100)
  lensMake         String?   @db.VarChar(100)
  lensModel        String?   @db.VarChar(100)
  dateTaken        DateTime? @db.DateTime(0)
  iso              Int?
  focalLength      String?   @db.VarChar(20)
  aperture         String?   @db.VarChar(20)
  shutterSpeed     String?   @db.VarChar(50)
  exposureMode     String?   @db.VarChar(50)
  whiteBalance     String?   @db.VarChar(50)
  flash            String?   @db.VarChar(50)
  orientation      Int?
  colorSpace       String?   @db.VarChar(50)
  tags             String?   @db.Text
  uploadSource     String?   @default("manual") @db.VarChar(50)
  hasGpsData       Boolean   @default(false)
  uploader         User?     @relation("PhotoUploader", fields: [userId], references: [id])

  @@index([placeId])
  @@index([userId])
  @@index([dateTaken], map: "idx_photos_dateTaken")
  @@index([hasGpsData], map: "idx_photos_hasGpsData")
  @@index([uploadSource], map: "idx_photos_uploadSource")
  @@map("photos")
}

model Project {
  id          Int               @id @default(autoincrement())
  userId      Int
  name        String
  description String?           @db.Text
  startDate   DateTime?
  endDate     DateTime?
  budget      Float?
  status      String            @default("planning")
  color       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  locations   ProjectLocation[]
  owner       User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "projects_userId_fkey")
  @@map("projects")
}

model ProjectLocation {
  id         Int       @id @default(autoincrement())
  projectId  Int
  locationId Int
  shootDate  DateTime?
  notes      String?   @db.Text
  addedAt    DateTime  @default(now())
  location   Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, locationId])
  @@index([locationId], map: "project_locations_locationId_fkey")
  @@map("project_locations")
}

model LocationContact {
  id         Int      @id @default(autoincrement())
  locationId Int
  name       String
  role       String?
  email      String?
  phone      String?
  notes      String?  @db.Text
  createdAt  DateTime @default(now())
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([locationId], map: "location_contacts_locationId_fkey")
  @@map("location_contacts")
}

model TeamMember {
  id        Int      @id @default(autoincrement())
  userId    Int
  invitedBy Int
  role      String   @default("viewer")
  joinedAt  DateTime @default(now())
  inviter   User     @relation("TeamInviter", fields: [invitedBy], references: [id], onDelete: Cascade)
  user      User     @relation("TeamMember", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, invitedBy])
  @@index([invitedBy], map: "team_members_invitedBy_fkey")
  @@map("team_members")
}

model SecurityLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  eventType String
  ipAddress String?
  userAgent String?  @db.Text
  location  String?
  success   Boolean  @default(true)
  metadata  Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@map("security_logs")
}
